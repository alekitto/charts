---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: {{ template "symbolicator.fullname" . }}
    labels:
        app: {{ template "symbolicator.fullname" . }}
        chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
        release: "{{ .Release.Name }}"
        heritage: "{{ .Release.Service }}"
spec:
    selector:
        matchLabels:
            app: {{ template "symbolicator.fullname" . }}
            release: "{{ .Release.Name }}"
    template:
        metadata:
{{- if .Values.annotations }}
            annotations:
{{ toYaml .Values.annotations | indent 16 }}
{{- end }}
            labels:
                app: {{ template "symbolicator.fullname" . }}
                release: "{{ .Release.Name }}"
{{- if .Values.podLabels }}
{{ toYaml .Values.podLabels | indent 16 }}
{{- end }}

        spec:
{{- if .Values.nodeSelector }}
            nodeSelector:
{{ toYaml .Values.nodeSelector | indent 16 }}
{{- end }}
{{- if .Values.image.imagePullSecrets }}
            imagePullSecrets:
{{ toYaml .Values.image.imagePullSecrets | indent 16 }}
{{- end }}
            containers:
                -   name: {{ include "symbolicator.fullname" . }}
                    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
                    imagePullPolicy: {{ .Values.image.pullPolicy }}
                    args: [ 'run' ]
                    ports:
                        -   containerPort: 3021
                    volumeMounts:
                        -   mountPath: /data
                            name: sentry-symbolicator-data
                            readOnly: false
            volumes:
                -   name: sentry-symbolicator-data
{{- if .Values.persistence.enabled }}
                    persistentVolumeClaim:
                        claimName: {{ .Values.persistence.existingClaim | default (include "symbolicator.fullname" .) }}
{{- else }}
                    emptyDir: {}
{{ end }}
