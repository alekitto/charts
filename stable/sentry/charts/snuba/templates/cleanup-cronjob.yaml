---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
    name: {{ template "snuba.fullname" . }}-cleanup
    labels:
        app: {{ template "snuba.fullname" . }}
        chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
        release: "{{ .Release.Name }}"
        heritage: "{{ .Release.Service }}"
spec:
    schedule: '*/5 * * * *'
    successfulJobsHistoryLimit: 1
    failedJobsHistoryLimit: 1
    jobTemplate:
        spec:
            template:
                metadata:
                    labels:
                        app: {{ template "snuba.fullname" . }}
                        release: "{{ .Release.Name }}"

                spec:
                    restartPolicy: OnFailure
{{- if .Values.nodeSelector }}
                    nodeSelector:
{{ toYaml .Values.nodeSelector | indent 28 }}
{{- end }}
{{- if .Values.image.imagePullSecrets }}
                    imagePullSecrets:
{{ toYaml .Values.image.imagePullSecrets | indent 28 }}
{{- end }}
                    containers:
                        -   name: {{ include "snuba.fullname" . }}
                            image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
                            imagePullPolicy: {{ .Values.image.pullPolicy }}
                            command: [ 'gosu', 'snuba', 'snuba', 'cleanup', '--dry-run', 'False' ]
                            env:
{{ include "snuba.environment" . | indent 32 }}
